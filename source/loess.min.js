// (c) 2015 Mark Huckvale University College London
function loess_fit(d,h,m,e,f,g,a){var b,k,c,n=0,p=0,l=0,q=0,r=0,t=0,u=0,v=0;b=0;k=e-1;do if(c=Math.floor((b+k)/2),g<d[c])k=c-1;else if(g>d[c])b=c+1;else break;while(b<=k);c=Math.floor((b+k)/2);f=Math.floor(.5+f*e);2>f&&(f=2);c=Math.round(c-f/2);0>c&&(c=0);c+f>e&&(c=e-f);b=Math.abs(g-d[c]);e=Math.abs(g-d[c+f-1]);e=b>e?b:e;switch(a){case 0:for(b=0;b<f;b++)a=Math.abs(g-d[c+b]),a/=e,a=1-a*a*a,a=a*a*a*m[c+b],p+=h[c+b]*a,l+=a;return p/l;case 1:for(b=0;b<f;b++)a=Math.abs(g-d[c+b]),a/=e,a=1-a*a*a,a=a*a*a*
m[c+b],p+=h[c+b]*a,n+=d[c+b]*a,q+=d[c+b]*d[c+b]*a,r+=d[c+b]*h[c+b]*a,l+=a;e=l*q-n*n;return(q*p-n*r)/e+(l*r-n*p)/e*g;case 2:for(b=0;b<f;b++)a=Math.abs(g-d[c+b]),a/=e,a=1-a*a*a,a=a*a*a*m[c+b],p+=h[c+b]*a,n+=d[c+b]*a,q+=d[c+b]*d[c+b]*a,t+=d[c+b]*d[c+b]*d[c+b]*a,v+=d[c+b]*d[c+b]*d[c+b]*d[c+b]*a,r+=d[c+b]*h[c+b]*a,u+=d[c+b]*d[c+b]*h[c+b]*a,l+=a;d=q-n*n/l;r-=n*p/l;t-=n*q/l;u-=q*p/l;h=v-q*q/l;v=(u*d-r*t)/(d*h-t*t);u=(r*h-u*t)/(d*h-t*t);return v*g*g+u*g+(p/l-u*n/l-v*q/l)}return 0}
function loess(d,h,m,e,f,g,a,b){var k=Array(g.length),c;for(c=0;c<a;c++)k[c]=loess_fit(d,h,m,e,f,g[c],b);return k}function compareNumbers(d,h){return d-h}function removeoutliers(d,h,m,e){var f,g,a,b,k;g=Array(h.length);for(f=0;f<e;f++)g[f]=Number(h[f]);g.sort(function(a,b){return a-b});a=g[Math.round(e/4)];b=g[Math.round(3*e/4)];k=1.5*(b-a);for(g=f=0;f<e;f++)h[f]<a-k||h[f]>b+k||(d[g]=d[f],h[g]=h[f],m[g]=m[f],g++);return{x:d.slice(0,g),y:h.slice(0,g),w:m.slice(0,g),n:g}}
function smoothfxloess(d,h,m){var e;e=0;var f=d.length,g=d[d.length-1],a=[],b=[],k=[];for(e=0;e<f;e++).3<m[e]&&(a.push(d[e]),b.push(h[e]),k.push(m[e]));trace("fxloess starts with "+a.length+" values");res=removeoutliers(a,b,k,a.length);a=res.x;b=res.y;k=res.w;e=res.n;trace("fxloess removes outliers, now "+a.length+" values");a=loess(a,b,k,e,.5/g,d,f,0);for(e=0;e<f;e++).3>=m[e]&&(h[e]=a[e],m[e]=.1);return loess(d,h,m,f,.25/g,d,f,1)};