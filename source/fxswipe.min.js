// (c) 2015 Mark Huckvale University College London
"undefined"===typeof window&&importScripts("fft.min.js");function log2(d){return Math.log10(d)/Math.log10(2)}function hz2erbs(d){return 6.44*(log2(229+d)-7.84)}function erbs2hz(d){return Math.pow(2,d/6.44+7.84)-229}function interp1(d,e,l){var g=new Float32Array(l.length),f=d.length,h,a,b;for(h=0;h<l.length;h++)if(b=l[h],b<=d[0])g[h]=e[0];else if(b>=d[f-1])g[h]=e[f-1];else for(a=1;a<f;a++)if(d[a-1]<=b&&b<=d[a]){b=(d[a]-b)/(d[a]-d[a-1]);g[h]=b*e[a-1]+(1-b)*e[a];break}return g}
var plim=[40,600],dt=.005,dlog2p=1/48,dERBs=.1,woverlap=.5,sTHR=-1E10,primes=[1,2,3,5,7,11,13,17,19,23,29,31,37,41,43,447,53,59,61,67,71,73,79,83,89,97,101,103,107,109,113,127,131,137,139,149,151,157,163,167,173,179,181,191,193,197,199,211,223,227,229,233,239,241,251,257,263,269,271,277,281,283,293,307,311,313,317,331,337,347,349,353,359,367,373,379,383,389,397,401,409,419,421,431,433,439,443,449,457,461,463,467,479,487,491,499],NPRIME=primes.length,maxnfERBs;
function allocvector(d){return new Float32Array(d)}function allocmatrix(d,e){var l,g=Array(d);for(l=0;l<d;l++)g[l]=new Float32Array(e);return g}function printvector(d,e,l){d=d+"="+e[0];for(var g=1;g<l;g++)d+=","+e[g];trace(d)}function P3Interpolate_Extremum(d,e,l,g,f,h){var a=e,b=f;g=2*((h-f)/(l-e)-(g-f)/(d-e))/(l-d);h=(h-f)/(l-e)-.5*g*(l-e);g&&(a=e-h/g,b=f+.5*h*(a-e));if(a<d||a>l)a=e,b=f;return{xe:a,ye:b}}var k=[],q=[],c2pq=[];
function pitchStrengthOneCandidate(d,e,l,g,f){var h=Math.floor(d[e+g-1]/f-.75),a;0==k.length&&(k=allocvector(maxnfERBs));0==q.length&&(q=allocvector(maxnfERBs));0==c2pq.length&&(c2pq=allocvector(maxnfERBs));for(a=0;a<g;a++)k[a]=0,q[a]=d[e+a]/f,c2pq[a]=Math.cos(2*Math.PI*q[a]);for(a=0;a<h&&a<NPRIME;a++){f=0;var b=g-1,c;do if(c=Math.floor((f+b)/2),q[c]<primes[a])f=c+1;else if(q[c]>primes[a])b=c-1;else break;while(f<b);for(;0<c&&q[c]>primes[a]-.75;)c--;for(f=c;f<g;f++)if(b=q[f]-primes[a],!(-.75>b))if(-.25>
b)k[f]+=c2pq[f]/2;else if(.25>b)k[f]+=c2pq[f];else if(.75>b)k[f]+=c2pq[f]/2;else break}for(a=h=0;a<g;a++)k[a]*=Math.sqrt(1/d[e+a]),0<k[a]&&(h+=k[a]*k[a]);d=Math.sqrt(h);for(a=h=0;a<g;a++)h+=k[a]*l[a]/d;return h}
function SWIPEP(d,e,l){var g=d.length,f=allocvector(l),h=allocvector(l),a,b,c,H,I,A,y,r,B,C=Array(2),w,D,E,G,t,m,u,n,v,p,F,x,z,J,L,K;A=1+Math.floor(g/e/dt);I=allocvector(A);for(a=0;a<A;a++)I[a]=a*dt;r=1+Math.floor((log2(plim[1])-log2(plim[0]))/dlog2p);b=allocvector(r);for(a=0;a<r;a++)b[a]=log2(plim[0])+a*dlog2p;y=allocvector(r);for(a=0;a<r;a++)y[a]=Math.pow(2,b[a]);B=allocmatrix(A,r);C[0]=Math.floor(.5+log2(8*e/plim[0]));C[1]=Math.floor(.5+log2(8*e/plim[1]));D=1+Math.floor(C[0]-C[1]);w=new Int32Array(D);
for(a=0;a<D;a++)w[a]=Math.pow(2,C[0]-a);C=allocvector(D);for(a=0;a<D;a++)C[a]=8*e/w[a];E=allocvector(r);for(a=0;a<r;a++)E[a]=1+b[a]-log2(8*e/w[0]);maxnfERBs=x=1+Math.floor((hz2erbs(e/2)-hz2erbs(y[0]/4))/dERBs);F=allocvector(x);for(a=0;a<x;a++)F[a]=erbs2hz(hz2erbs(y[0]/4)+a*dERBs);var M=new RealFFT;for(a=0;a<D;a++){c=Math.floor(.5+8*(1-woverlap)*e/C[a]);1>c&&(c=1);n=w[a]/2;G=allocvector(g+3*n);for(b=0;b<g;b++)G[n+b]=d[b];t=allocvector(w[a]);m=2*Math.PI/(w[a]-1);for(b=0;b<w[a];b++)t[b]=.5-.5*Math.cos(b*
m);m=w[a]-c;0>m&&(m=0);n=Math.floor((g+2*n)/(w[a]-m));for(v=2;v<w[a];)v*=2;u=allocmatrix(n,v);for(b=0;b<n;b++){for(c=0;c<w[a];c++)u[b][c]=G[b*(w[a]-m)+c]*t[c];u[b]=M.RealFFTPower(u[b],w[a])}p=allocvector(v/2);for(c=0;c<v/2;c++)p[c]=c*e/v;G=allocvector(n);for(c=0;c<n;c++)G[c]=c*(w[a]-m)/e;t=new Int32Array(r);v=new Int32Array(r);b=m=0;if(1==D)for(c=0;c<r;c++)t[m++]=c;else if(a+1==D){for(c=0;c<r;c++)-1<E[c]-a-1&&(t[m++]=c);for(c=0;c<m;c++)0>E[t[c]]-a-1&&(v[b++]=c)}else if(0==a){for(c=0;c<r;c++)1>E[c]-
1&&(t[m++]=c);for(c=0;c<m;c++)0<E[t[c]]-1&&(v[b++]=c)}else{for(c=0;c<r;c++)1>Math.abs(E[c]-a-1)&&(t[m++]=c);for(c=0;c<m;c++)v[b++]=c}for(b=0;b<x&&!(F[b]>y[t[0]]/4);b++);for(c=0;c<x-b;c++)F[c]=F[b+c];x-=b;z=allocmatrix(n,x);for(b=0;b<n;b++)for(z[b]=interp1(p,u[b],F),c=0;c<x;c++)z[b][c]=Math.sqrt(0<z[b][c]?z[b][c]:0);u=m+1;p=new Int32Array(u);for(b=p[0]=0;b<u-1;b++){for(c=0;c<x-p[b]&&!(F[p[b]+c]>y[t[b]]/4);c++);p[b+1]=p[b]+c}for(b=0;b<u-1;b++)p[b]=p[b+1]+1;J=allocmatrix(n,x);for(b=0;b<n;b++)for(u=0,
c=x-1;0<=c;c--)u+=z[b][c]*z[b][c],J[b][c]=Math.sqrt(u);u=allocmatrix(n,m);K=allocmatrix(n,x);for(b=0;b<m;b++)for(c=0;c<n;c++){L=J[c][p[b]];for(H=p[b]-1;H<x;H++)K[c][H-p[b]+1]=z[c][H]/L;u[c][b]=pitchStrengthOneCandidate(F,p[b]-1,K[c],x-p[b]+1,y[t[b]])}c=allocvector(m);for(b=0;b<m;b++)c[b]=E[t[v[b]]]-a-1;v=allocvector(m);for(b=0;b<m;b++)v[b]=1-Math.abs(c[b]);z=allocvector(n);allocvector(A);for(b=0;b<m;b++){for(c=0;c<n;c++)z[c]=u[c][b];p=interp1(G,z,I);for(c=0;c<A;c++)B[c][t[b]]+=v[b]*p[c]}}for(a=0;a<
A&&a<l;a++){d=sTHR;for(b=e=0;b<r;b++)B[a][b]>d&&(d=B[a][b],e=b);d<=sTHR?(f[a]=0,h[a]=d):0==e||e==r-1?(f[a]=y[e],h[a]=d):(d=P3Interpolate_Extremum(y[e-1],y[e],y[e+1],B[a][e-1],B[a][e],B[a][e+1]),f[a]=d.xe,h[a]=d.ye)}return{fx:f,vs:h,fxlen:A<l?A:l}}self.onmessage=function(d){var e=d.data.signal;d=d.data.srate;var l=Math.round(e.length/d*200),e=SWIPEP(e,d,l);postMessage(e)};