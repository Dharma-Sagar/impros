// (c) 2015 Mark Huckvale University College London
function MFCC(t){var k=this.constructor.prototype;this.srate=t;this.winsize=Math.round(.02*t);this.stpsize=Math.round(.01*t);for(this.fftsize=2;this.fftsize<this.winsize;)this.fftsize*=2;this.ncoeff=12;this.nparam=this.ncoeff+1;this.preemp=.95;this.lofreq=100;this.hifreq=8E3;this.cepslifter=23;k.mylog10=function(a){return 1E-10>a?-10:Math.log10(a)};k.HertzToMel=function(a){return 1E3/Math.log(2)*Math.log(1+a/1E3)};k.MelToHertz=function(a){return 1E3*(Math.exp(Math.log(2)/1E3*a)-1)};this.designFilterBank=
function(){var a,c,b;trace("lo="+this.lofreq+" hi="+this.hifreq);b=Math.round(1+(k.HertzToMel(this.hifreq)-k.HertzToMel(this.lofreq))/150);trace("nfilt="+b);this.filtab=Array(b);lf=k.MelToHertz(k.HertzToMel(this.lofreq)+150);hf=k.MelToHertz(k.HertzToMel(this.hifreq)-150);a=lf;for(b=0;a<=hf;)a=k.HertzToMel(a),this.filtab[b]={},this.filtab[b].lidx=Math.round(this.fftsize*(k.MelToHertz(a-150)/this.srate)),this.filtab[b].cidx=Math.round(this.fftsize*(k.MelToHertz(a)/this.srate)),this.filtab[b].hidx=Math.round(this.fftsize*
(k.MelToHertz(a+150)/this.srate)),a=k.MelToHertz(a+150),b++;this.nfilt=b;for(a=0;a<b;a++){this.filtab[a].win=new Float32Array(this.fftsize/2);for(c=0;c<this.fftsize/2;c++)this.filtab[a].win[c]=0;for(c=this.filtab[a].lidx;c<this.filtab[a].cidx;c++)this.filtab[a].win[c]=1-(this.filtab[a].cidx-c)/(this.filtab[a].cidx-this.filtab[a].lidx+1);for(c=this.filtab[a].cidx;c<=this.filtab[a].hidx;c++)this.filtab[a].win[c]=1-(c-this.filtab[a].cidx)/(this.filtab[a].hidx-this.filtab[a].cidx+1)}b=2*Math.PI/(this.winsize-
1);this.hamming=new Float32Array(this.winsize);for(a=0;a<this.winsize;a++)this.hamming[a]=.54-.46*Math.cos(a*b)};k.four1=function(a,c){var b,e,f,d,k,h,p,u,q,n,m,l;b=c<<1;for(h=d=1;h<b;h+=2){d>h&&(m=a[d],a[d]=a[h],a[h]=m,l=a[d+1],a[d+1]=a[h+1],a[h+1]=l);for(f=b>>1;2<=f&&d>f;)d-=f,f>>=1;d+=f}for(e=2;b>e;){k=2*e;f=2*Math.PI/e;d=Math.sin(.5*f);u=-2*d*d;q=Math.sin(f);p=1;n=0;for(f=1;f<e;f+=2){for(h=f;h<=b;h+=k)d=h+e,m=p*a[d]-n*a[d+1],l=p*a[d+1]+n*a[d],a[d]=a[h]-m,a[d+1]=a[h+1]-l,a[h]+=m,a[h+1]+=l;p=(d=
p)*u-n*q+p;n=n*u+d*q+n}e=k}};k.RealFFTPower=function(a,c){var b,e,f,d,v,h,p,u,q,n,m,l,w,x,g,t,r=c;g=new Float32Array(r+1);for(b=1;b<=c;b++)g[b]=a[b-1];r>>=1;t=new Float32Array(r);b=Math.PI/r;k.four1(g,r);e=Math.sin(.5*b);w=-2*e*e;x=Math.sin(b);m=1+w;l=x;h=2*r+3;for(b=2;b<=r/2;b++)v=1+(d=h-(f=1+(e=b+b-1))),p=.5*(g[e]+g[d]),u=.5*(g[f]-g[v]),q=.5*(g[f]+g[v]),n=-.5*(g[e]-g[d]),g[e]=p+m*q-l*n,g[f]=u+m*n+l*q,g[d]=p-m*q+l*n,g[v]=-u+m*n+l*q,m=(e=m)*w-l*x+m,l=l*w+e*x+l;g[1]=(p=g[1])+g[2];g[2]=p-g[2];for(b=
0;b<r;b++)t[b]=Math.sqrt(g[2*b+1]*g[2*b+1]+g[2*b+2]*g[2*b+2]);return t};this.calcMFCCFrame=function(a){var c,b=new Float32Array(this.fftsize);b[0]=(a[1]-this.preemp*a[0])*this.hamming[0];var e=b[0]*b[0];for(c=1;c<this.winsize;c++)b[c]=(a[c]-this.preemp*a[c-1])*this.hamming[c],e+=b[c]*b[c];for(;c<this.fftsize;c++)b[c]=0;b=k.RealFFTPower(b,this.fftsize);a=new Float32Array(this.nfilt);for(c=0;c<this.nfilt;c++)for(a[c]=0,j=this.filtab[c].lidx;j<=this.filtab[c].hidx;j++)a[c]+=this.filtab[c].win[j]*b[j];
b=Array(this.nparam);for(c=0;c<this.ncoeff;c++){var f=Math.PI*(c+1)/this.nfilt,d=0;for(j=0;j<this.nfilt;j++)d+=this.mylog10(a[j])*Math.cos((j+.5)*f);b[c]=d}b[this.ncoeff]=this.mylog10(e);return b};this.calcMFCC=function(a){var c,b=Math.floor((a.length-this.winsize)/this.stpsize),e=Array(b);for(c=0;c<b;c++){var f=a.subarray(c*this.stpsize,c*this.stpsize+this.winsize);e[c]={};e[c].coef=this.calcMFCCFrame(f);e[c].posn=c*this.stpsize;e[c].time=c*this.stpsize/this.srate}return e};this.designFilterBank()}
;