// (c) 2015 Mark Huckvale University College London
function trace(m){"object"==typeof console&&console.log(m)}Complex=function(){this.im=this.re=0};FilterSection=function(){this.ncoeff=0;this.acoeff=Array(5);this.bcoeff=Array(5);this.memory=[0,0,0,0,0,0]};
Filter=function(){var m=this.constructor.prototype;this.MAX_ORDER=20;this.LOW_PASS=1;this.HIGH_PASS=2;this.BAND_PASS=3;this.BAND_STOP=4;this.section=this.nsection=0;this.a=Array(this.MAX_ORDER);this.b=Array(this.MAX_ORDER);m.transform=function(f,b,a,d,c){var g,k,l,h=Array(3),e=Array(3),m=Array(3);switch(c){case this.LOW_PASS:c=Math.sin(Math.PI*(b-a))/Math.sin(Math.PI*(b+a));b=-c;a=1;d=0;g=a;k=b;l=0;c=3;break;case this.HIGH_PASS:c=-Math.cos(Math.PI*(b+a))/Math.cos(Math.PI*(b-a));b=-c;a=-1;d=0;g=-a;
k=-b;l=0;c=3;break;case this.BAND_PASS:c=Math.cos(Math.PI*(d+a))/Math.cos(Math.PI*(d-a));a=Math.tan(Math.PI*b)/Math.tan(Math.PI*(d-a));b=-(a-1)/(a+1);a=2*c*a/(a+1);d=-1;g=-d;k=-a;l=-b;c=5;break;case this.BAND_STOP:c=Math.cos(Math.PI*(d+a))/Math.cos(Math.PI*(d-a));a=Math.tan(Math.PI*b)*Math.tan(Math.PI*(d-a));b=(1-a)/(a+1);a=-2*c/(a+1);g=d=1;k=a;l=b;c=5;break;default:throw"filter: unknown filter type: "+c;}h[0]=Array(5);h[0][0]=g*g;h[0][1]=2*g*k;h[0][2]=k*k+2*g*l;h[0][3]=2*k*l;h[0][4]=l*l;h[1]=Array(5);
h[1][0]=b*g;h[1][1]=b*k+a*g;h[1][2]=b*l+a*k+d*g;h[1][3]=a*l+d*k;h[1][4]=d*l;h[2]=Array(5);h[2][0]=b*b;h[2][1]=2*b*a;h[2][2]=a*a+2*b*d;h[2][3]=2*a*d;h[2][4]=d*d;for(b=0;b<f;b++){for(a=0;3>a;a++)e[a]=this.a[b][a],m[a]=this.b[b][a];for(a=0;5>a;a++)for(this.a[b][a]=0,d=this.b[b][a]=0;3>d;d++)this.a[b][a]+=h[d][a]*e[d],this.b[b][a]+=h[d][a]*m[d]}for(b=0;b<f;b++){for(a=1;a<c;a++)this.a[b][a]/=this.b[b][0],this.b[b][a]/=this.b[b][0];this.a[b][0]/=this.b[b][0];this.b[b][0]=1}return c};m.design=function(f,
b,a,d,c){var g=Array(this.MAX_ORDER),k=Array(this.MAX_ORDER),l,h,e;switch(f){case this.LOW_PASS:l=a/c;break;case this.HIGH_PASS:l=(c-a)/c;break;case this.BAND_PASS:l=(d-a)/c;break;case this.BAND_STOP:l=(d-a)/c;break;default:throw"filter: unknown filter type: "+f;}if(b>this.MAX_ORDER)throw"filter: order of filter too large";if(b&1)throw"filter: filter order must be even";h=Math.tan(Math.PI*l);this.nsection=b/2;for(e=0;e<this.nsection;e++){var m;m=Math.PI*(2*e+1)/(2*b);g[e]=-h*Math.cos(m);k[e]=h*Math.sin(m)}for(e=
0;e<this.nsection;e++)b=k[e]*k[e],h=(1-g[e])*(1-g[e]),g[e]=(1-g[e]*g[e]-b)/(h+b),k[e]=2*k[e]/(h+b);for(e=0;e<this.nsection;e++)this.b[e]=Array(5),this.b[e][0]=1,this.b[e][1]=-2*g[e],this.b[e][2]=g[e]*g[e]+k[e]*k[e],this.b[e][3]=0,this.b[e][4]=0;for(e=0;e<this.nsection;e++)g=4/(this.b[e][0]+this.b[e][1]+this.b[e][2]),this.a[e]=Array(5),this.a[e][0]=1/g,this.a[e][1]=2/g,this.a[e][2]=1/g,this.a[e][3]=0,this.a[e][4]=0;a=f!=this.LOW_PASS?this.transform(this.nsection,l,a/c,d/c,f):3;this.section=Array(this.nsection);
for(e=0;e<this.nsection;e++)for(this.section[e]=new FilterSection,this.section[e].ncoeff=a,f=0;f<a;f++)this.section[e].acoeff[f]=this.a[e][f],this.section[e].bcoeff[f]=this.b[e][f]};m.resonator=function(f,b,a){this.nsection=1;this.section=Array(1);this.section[0]=new FilterSection;this.section[0].ncoeff=3;f=2*Math.PI*f/a;b=1-2*Math.PI*b/a/2;this.section[0].acoeff[0]=1;this.section[0].acoeff[1]=0;this.section[0].acoeff[2]=0;this.section[0].bcoeff[0]=1;this.section[0].bcoeff[1]=-2*b*Math.cos(f);this.section[0].bcoeff[2]=
b*b;a=this.response(0,a);this.section[0].acoeff[0]/=a;this.section[0].acoeff[2]/=a};m.amplifier=function(f){this.nsection=1;this.section=Array(1);this.section[0]=new FilterSection;this.section[0].ncoeff=1;this.section[0].acoeff[0]=f;this.section[0].bcoeff[0]=1};m.vocaltract=function(f,b,a,d){var c;this.nsection=3;this.section=Array(3);for(c=0;3>c;c++)this.section[c]=new FilterSection,this.section[c].ncoeff=3,this.section[c].acoeff[0]=1,this.section[c].acoeff[1]=0,this.section[c].acoeff[2]=0,this.section[c].bcoeff[0]=
1;f=2*Math.PI*f/d;c=120*Math.PI/d;c=1-c/2;this.section[0].bcoeff[1]=-2*c*Math.cos(f);this.section[0].bcoeff[2]=c*c;f=2*Math.PI*b/d;c=180*Math.PI/d;c=1-c/2;this.section[1].bcoeff[1]=-2*c*Math.cos(f);this.section[1].bcoeff[2]=c*c;f=2*Math.PI*a/d;c=240*Math.PI/d;c=1-c/2;this.section[2].bcoeff[1]=-2*c*Math.cos(f);this.section[2].bcoeff[2]=c*c;b=this.response(0,d);this.section[0].acoeff[0]/=b};m.clear=function(){var f,b;for(f=0;f<this.nsection;f++)for(b=0;b<=this.section[f].ncoeff;b++)this.section[f].memory[b]=
0};m.sample=function(f){var b,a,d,c;for(b=0;b<this.nsection;b++){d=this.section[b].ncoeff-1;this.section[b].memory[d]=f;for(a=f=0;a<this.section[b].ncoeff-1;a++)c=d-a,this.section[b].memory[d]-=this.section[b].bcoeff[c]*this.section[b].memory[a],f+=this.section[b].acoeff[c]*this.section[b].memory[a],this.section[b].memory[a]=this.section[b].memory[a+1];f+=this.section[b].acoeff[0]*this.section[b].memory[d]}return f};m.process=function(f){var b,a=new Float32Array(new ArrayBuffer(4*f.length));this.clear();
for(b=0;b<f.length;b++)a[b]=this.sample(f[b]);return a};m.CMLT=function(f,b){var a=new Complex;a.re=f.re*b.re-f.im*b.im;a.im=f.re*b.im+f.im*b.re;return a};m.response=function(f,b){var a,d,c=Array(5),g=new Complex,k=new Complex,l=new Complex,h=new Complex,e;d=2*Math.PI*f/b;for(a=0;5>a;a++)c[a]=new Complex;c[0].re=1;c[0].im=0;c[1].re=Math.cos(d);c[1].im=Math.sin(d);c[2]=this.CMLT(c[1],c[1]);c[3]=this.CMLT(c[2],c[1]);c[4]=this.CMLT(c[2],c[2]);g.re=1;for(a=g.im=0;a<this.nsection;a++){k.re=0;k.im=0;l.re=
0;for(d=l.im=0;d<this.section[a].ncoeff;d++)k.re+=c[d].re*this.section[a].acoeff[d],k.im+=c[d].im*this.section[a].acoeff[d],l.re+=c[d].re*this.section[a].bcoeff[d],l.im+=c[d].im*this.section[a].bcoeff[d];d=Math.sqrt(k.re*k.re+k.im*k.im);e=Math.sqrt(l.re*l.re+l.im*l.im);0==d||0==e?(h.re=0,h.im=0):(h.re=d/e*(k.im/d*(l.im/e)+k.re/d*(l.re/e)),h.im=d/e*(k.im/d*(l.re/e)-k.re/d*(l.im/e)));d=g.re*h.re-g.im*h.im;g.im=g.re*h.im+g.im*h.re;g.re=d}return d=Math.sqrt(g.re*g.re+g.im*g.im)}};